import React, { useEffect, useState} from 'react';
import Modal from 'react-modal';
//import axios from 'axios';
import { Container, Header, Input, Button, Sheet, AddEditWorkout, MessageItem, RestTimer } from './components/styles/styles';
import { saveAs } from 'file-saver';

const App = () => {
  const today = new Date();
  // const date = `${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`;
  const date = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  // const time = today.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', second: 'numeric' });

  const [time, setTime] = useState(new Date().toLocaleTimeString());
  const [workoutModalIsOpen, setWorkoutModalIsOpen] = useState(false);
  const [workoutName, setWorkoutName] = useState('');
  const [workouts, setWorkouts] = useState([]);
  const [selectedWorkout, setSelectedWorkout] = useState({title: '', exercises: []});
  const [editWorkout, setEditWorkout] = useState(false);
  const [exercises, setExercises] = useState([{name: '', sets: '', reps: '', rest: ''}]);
  const [editingIndex, setEditingIndex] = useState(null);
  const [timer, setTimer] = useState(0);
  const [timerRunning, setTimerRunning] = useState(false);
  const [logModalIsOpen, setLogModalIsOpen] = useState(false);
  const [workoutLogs, setWorkoutLogs] = useState([]);
  const [exerciseLogs, setExerciseLogs] = useState({});
  const [currentLog, setCurrentLog] = useState([{ reps: '', weight: '' }]);
  const [currentExerciseLog, setCurrentExerciseLog] = useState(null);
  const [sets, setSets] = useState([{ reps: '', weight: '' }]);
  const [logDate, setCurrentLogDate] = useState(null);

  // Clock
  useEffect(() => {
    const interval = setInterval(() => {
      setTime(new Date().toLocaleTimeString());
    }, 1000);
    return () => clearInterval(interval);
  }, []);

  // Initialize workouts for the app by fetching data from the backend
  useEffect(() => {
    const loadWorkouts = async () => {
      const response = await fetch('/api/workouts'); 
      const data = await response.json(); // returns the workouts from the database with the id (generated by database), title, and exercises
      setWorkouts(data);
      setSelectedWorkout(data[data.length -1]); // set the last workouts as the current workouts
    };
    loadWorkouts();
    console.log('workouts', workouts);
  }, []);

  // Timer logic
  useEffect(() => {
    let interval = null;
    if (timerRunning && timer > 0) {
      interval = setInterval(() => {
        setTimer(timer => timer - 1);
      }, 1000);
    } else if (!timerRunning && timer !== 0) {
      clearInterval(interval);
    }
    return () => clearInterval(interval);
  }, [timerRunning, timer]);

  // Logs 
  useEffect(() => {
    if (currentExerciseLog) {
      setExerciseLogs(prevLogs => {
        const logs = {...prevLogs};
        if (!logs[currentExerciseLog.id]) {
          logs[currentExerciseLog.id] = [{ reps: '', weight: '' }];
        }
        return logs;
      });
    }
  }, [currentExerciseLog]);

  // Timer functions
  const startTimer = (rest) => {
    setTimer(rest);
    setTimerRunning(true);
  }

  // Modal functions
  const openCloseWorkoutModal = (change) => {
    setWorkoutModalIsOpen(change); // true open, false close
  }

  const pauseTimer = () => {
    setTimerRunning(false);
  } 

  const resetTimer = () => {
    setTimer(0);
    setTimerRunning(false);
  };

  const resumeTimer = () => {
    setTimerRunning(true);
  }

  // CRUD functions
  const loadWorkout = async (workoutsId) => {
    const workoutsResponse = await fetch(`/api/workouts/${workoutsId}`); // transmits data incrementally from HTTP server: GET by default
    const workoutsData = await workoutsResponse.json(); // using another await to make sure we process the whole response
    setSelectedWorkout(workoutsData);

    const exercisesResponse = await fetch(`/api/exercises/${workoutsId}`);
    const exercisesData = await exercisesResponse.json();
    setExercises(exercisesData);

    const logsResponse = await fetch(`/api/logs/${workoutsId}`);
    const logsData = await logsResponse.json();
    setWorkoutLogs(logsData);
  };


  const addWorkout = async () => {
    if (workouts.some(workout => workout.title === workoutName)) {
      alert('Workout already exists');
      return;
    }
    const workoutsData = { title: workoutName , exercises: exercises }; // we send an empty array of exercises to add to the workouts later
    const response = await fetch('/api/workouts', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(workoutsData),
    });
    const data = await response.json(); // checking to see if the response is ok

    // Send a POST request to the add exercises endpoint for each exercise
    const newExercises = [];
    for (const exercise of exercises) {
      const exerciseResponse = await fetch(`/api/exercises/${data.id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(exercise), // Include the workoutId in the request body
      });
      const newExercisesData = await exerciseResponse.json();
      newExercises.push(newExercisesData);
    }

    setSelectedWorkout({...data, exercises: newExercises}); // set the new workout as the selected workout
    setWorkouts(prev => [...prev, {...data, exercises: newExercises}]); // add the new workouts to the workouts array
    setWorkoutName('');
    setWorkoutModalIsOpen(false); // close the modal
  };

  const handleAddWorkout = () => {
    setWorkoutModalIsOpen(true);
    setEditWorkout(false);
    setExercises([{name: '', sets: '', reps: '', rest: ''}]);
  }

  const handleEditWorkout = async () => {
    setWorkoutModalIsOpen(true);
    setEditWorkout(true);
    setWorkoutName(selectedWorkout.title);
    
    console.log('selectedWorkout: ', selectedWorkout);
    const response = await fetch(`/api/exercises/${selectedWorkout.id}`);
    const data = await response.json();

    setExercises(data);
  }

  const deleteWorkout = async () => {
    const confirmDelete = window.confirm('Are you sure you want to delete this workout?');
    if (!confirmDelete) {
      return;
    }
    await fetch(`/api/workouts/${selectedWorkout.id}`, {
      method: 'DELETE',
    });
  
    // Update the workouts state
    const newWorkouts = workouts.filter(workout => workout.id !== selectedWorkout.id);
    setWorkouts(newWorkouts);
  
    // Set the selectedWorkout state to the first workout in the workouts array
    if (newWorkouts.length > 0) {
      setSelectedWorkout(newWorkouts[0]);
    } else {
      setSelectedWorkout(null); // or set to an empty workout object if it makes more sense in your context
    }
  
    // Close the modal
    setWorkoutModalIsOpen(false);
  };

  const updateWorkout = async (newWorkoutsData) => { // newWorkoutsData is the new data we want to update coming from the form
    console.log('newWorkoutsData', newWorkoutsData);
    let response = await fetch(`/api/workouts/${selectedWorkout.id}`, { 
      method: 'PUT', // use PUT to update the data instead of POST
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(newWorkoutsData),
    });
    let data = await response.json(); // check if the response is ok
    setSelectedWorkout(data); // set the new workout as the selected workout
    setWorkouts(prev => prev.map(workout => workout.id === data.id ? data : workout));

    // Update the exercises
    const updatedExercises = [];
    for (const exercise of exercises) {
      if (exercise.id) {
        const response = await fetch(`/api/exercises/${exercise.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(exercise),
        });
        const updatedExercise = await response.json();
        updatedExercises.push(updatedExercise);
    } else {
        const response = await fetch(`/api/exercises/${selectedWorkout.id}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(exercise),
        });
        const newExercise = await response.json();
        updatedExercises.push(newExercise);
      }
    }

    // Fetch the updated workout
    response = await fetch(`/api/exercises/${selectedWorkout.id}`);
    data = await response.json();

    if (Array.isArray(workouts)) {
      setWorkouts(prev => prev.map(workouts => workouts.id === data.id ? data : workouts)); // should update the workouts array with the new workout name 
    }

    setSelectedWorkout(prev => ({ ...prev, exercises: updatedExercises })); // update the selected workout with the new exercises
    setWorkoutModalIsOpen(false);
  }

  const handleInput = (index, event) => {
    const values = [...exercises];
    values[index][event.target.name] = event.target.value;
    setExercises(values);
  };

  const handleCancelEditWorkout = () => {
    openCloseWorkoutModal(false);
    setExercises([{name: '', sets: '', reps: '', rest: ''}]);
  }

  const addExercise = () => {
    setExercises([...exercises, { name: "", sets: "", reps: "", rest: "" }]);
  };

  const removeExercise = async (index) => {
    const newExercises = [...exercises];
    const removedExercise = newExercises.splice(index, 1)[0];

    if (newExercises.length === 0) {
      newExercises.push({ name: "", sets: "", reps: "", rest: "" });
    }

    if (removedExercise.id && selectedWorkout.exercises.find(exercise => exercise.id === removedExercise.id)) {
      await fetch(`/api/exercises/${removedExercise.id}`, {
        method: 'DELETE',
      });
    
      setSelectedWorkout(prev => ({
        ...prev,
        exercises: prev.exercises.filter(exercise => exercise.id !== removedExercise.id),
      }));
    }

    setExercises(newExercises);
  };

  const handleOpenLogModal = (exerciseId, date) => {
    setLogModalIsOpen(true);
    setCurrentExerciseLog(exerciseId);
    console.log('exerciseId', exerciseId);
    setCurrentLogDate(date);
  
    if (!exerciseLogs[exerciseId] || !exerciseLogs[exerciseId][date]) {
      const newLog = [{ reps: '', weight: '' }];
      setExerciseLogs(prevLogs => ({
        ...prevLogs,
        [exerciseId]: {
          ...prevLogs[exerciseId],
          [date]: newLog,
        },
      }));
      setCurrentLog(newLog)
    } else {
      setCurrentLog(exerciseLogs[exerciseId][date]);
    }
  };

  const handleCloseLogModal = () => {
    setLogModalIsOpen(false);
  }

  const handleLogSubmit = (event) => {
    event.preventDefault();

    // Get the form data
    const sets = event.target.elements.sets.value;
    const reps = event.target.elements.reps.value;
    const weight = event.target.elements.weight.value;

    // Create a new log
    const log = {
      exerciseId: currentExerciseLog.id,
      sets,
      reps,
      weight,
      date: new Date(),
    };

    setCurrentExerciseLog(null);
  };

  const handleAddExerciseSetLog = (exerciseId) => {
    setExerciseLogs(prevLogs => ({ 
      ...prevLogs,
      [currentExerciseLog]: {
        ...prevLogs[currentExerciseLog],
        [logDate]: [...prevLogs[currentExerciseLog][logDate], { reps: '', weight: '' }],
      }
    }));
  };

  const handleRemoveExerciseSetLog = (exerciseId, index) => {
    setExerciseLogs(prevLogs => {
      const logs = {...prevLogs};
      logs[exerciseId] = logs[exerciseId].filter((set, i) => i !== index);
      if (logs[exerciseId].length === 0) {
        logs[exerciseId] = [{ reps: '', weight: '' }];
      }
      return logs
    });
  };

  const exportWorkout = async () => {
    console.log('exporting workout...');

    // Send a GET request to the export endpoint
    const response = await fetch(`/api/exportWorkouts/${selectedWorkout.id}`);

    // Check if the request was successful
    if (!response.ok) {
      console.error('Failed to export workout');
      return;
    }

    // Get the filename from the Content-Disposition header
    const contentDisposition = response.headers.get('Content-Disposition');
    const filename = contentDisposition.split('filename=')[1];

    // Get the file data from the response
    const blob = await response.blob();

    // Use FileSaver to save the file
    saveAs(blob, filename);
  };

  // Render the app
  return (
    <Container>
      <Header>
        <h1>Simple Workout App</h1>
        <p>Date: {date}</p>
        <p>Time: {time}</p>
        <p>Rest Timer: {timer}</p>
      </Header>
      <Sheet>
        {/* as soon as we click on a workout we retrieve the available workouts/exercises from our backend */}
        <AddEditWorkout>
         <select onChange={e => loadWorkout(e.target.value)}> 
          <option>Select a workout</option>
          {workouts.map((workouts, index) => (
            <option key={index} value={workouts.id}>{workouts.title}</option>
          ))}
        </select>
        <Button onClick={handleAddWorkout}>Add Workout</Button>
        <Button onClick={handleEditWorkout}>Edit Workout</Button>
        <Button onClick={exportWorkout}>Export Workout</Button>
        </AddEditWorkout>
        {selectedWorkout ? (
        <>
            {/* <Button onClick={() => setExerciseModalIsOpen(true)}>Add Exercise</Button> */}
            <Header>{selectedWorkout.title}</Header>
            <table>
              <thead>
                <tr>
                  <th>Exercise</th>
                  <th>Sets  </th>
                  <th>Reps  </th>
                  <th>Rest  </th>
                  <th>Progress </th>
                </tr>
              </thead>
              <tbody>
                {selectedWorkout && selectedWorkout.exercises.map((exercise, index) => ( 
                <tr key={index}>
                  <td>{exercise.name}</td>
                  <td>{exercise.sets}</td>
                  <td>{exercise.reps}</td>
                  <td>{exercise.rest}</td>
                  <td>
                    {/* {timer !== null ? timer : '0'} */}
                    <button onClick={() => startTimer(exercise.rest)}>Start</button>
                    <button onClick={pauseTimer}>Pause</button>
                    <button onClick={resumeTimer}>Resume</button>
                    <button onClick={resetTimer}>Reset</button>
                  </td>
                  <td>
                    <button onClick={() => handleOpenLogModal(exercise, date)}>Log</button>
                  </td>
                  {/* TODO: <td></td> add progress bar here with new date, set number, and reps performed storage */}
                </tr>
                ))}
              </tbody>
            </table>
          </>
        ) : (
          <p>No workouts yet. Click "Add workouts" to create a new workouts.</p>
        )}
      </Sheet>

      <Modal isOpen={workoutModalIsOpen}>
              <h2>{editWorkout ? `Edit Workout: ${selectedWorkout.title}` : 'Add Workout'}</h2>
              <form onSubmit={(e) => {
                e.preventDefault(); 
                editWorkout ? updateWorkout({id: selectedWorkout.id, title: workoutName, exercises: exercises}) : addWorkout();
                }}>
                <input
                  type="text"
                  name="title"
                  value={editWorkout ? workoutName : null}
                  onChange={e => setWorkoutName(e.target.value)}
                  placeholder='Enter new workout name'
                  required
                />
                <><p>Exercises: </p></>

                {exercises.map((exercise, index) => (
                <div key={index}>
                  <input
                    type="text"
                    name="name"
                    value={exercise.name}
                    onChange={(event) => handleInput(index, event)}
                    placeholder="Exercise"
                  />
                  <input
                    type="number"
                    name="sets"
                    value={exercise.sets}
                    onChange={(event) => handleInput(index, event)}
                    placeholder="Sets"
                  />
                  <input
                    type="number"
                    name="reps"
                    value={exercise.reps}
                    onChange={(event) => handleInput(index, event)}
                    placeholder="Reps"
                  />
                  <input
                    type="number"
                    name="rest"
                    value={exercise.rest}
                    onChange={(event) => handleInput(index, event)}
                    placeholder="Rest"
                  />
                <button type="button" onClick={addExercise}>+</button>
                <button type="button" onClick={() => removeExercise(index)}>-</button>
                </div>
                ))}

                <div>
                  <> </>
                  <Button type="submit">{editWorkout ? 'Update' : 'Add Workout'}</Button>
                  {editWorkout ? <Button type="submit" onClick={deleteWorkout}>Delete</Button> : null}
                  <Button type="button" onClick={handleCancelEditWorkout}>Cancel</Button>
                </div>
            </form>
      </Modal>

      <Modal isOpen={logModalIsOpen}>
        <h2>{currentLog ? currentLog.name : ''} Log</h2>
        <select> 
          <option>Select Log Date</option>
          <option>Today</option>
          <option>Yesterday</option>
        </select>
        <form onSubmit={handleLogSubmit}>
          {currentLog && exerciseLogs[currentLog.id] && exerciseLogs[currentLog.id].map((set, index) => (
            <div key={index}> 
          <label>
            Set: {index + 1}
          </label>
          <br />
          <label>
            Reps:
            <input type="number" name={`reps: ${index}`} />
          </label>
          <label>
            Weight:
            <input type="number" name={`weight: ${index}`} />
          </label>
          <button type="button" onClick={() => handleAddExerciseSetLog(currentLog.id)}>+</button>
          <button type="button" onClick={() => handleRemoveExerciseSetLog(currentLog.id, index)}>-</button>
            </div>
          ))}
        </form>
        <Button type="submit">Save Log</Button>
        <Button type="button" onClick={handleCloseLogModal}>Cancel</Button>
    </Modal>

    </Container>
  );
};

export default App;